<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-04-30">

<title>Cross-trait learning with a canonical transformer tops custom attention in genotype-phenotype mapping –</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./assets/logo_white.png" rel="icon" type="image/png">
<script src="site_libs/cookie-consent/cookie-consent.js"></script>
<link href="site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-e1a5c8363afafaef2c763b6775fbf3ca.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-6398a52119e632be5115e66ed2363dd4.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/iconify-2.1.0/iconify-icon.min.js"></script>
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-XXZF3HXS3G"></script>

<script type="text/plain" cookie-consent="tracking">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-XXZF3HXS3G', { 'anonymize_ip': true});
</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"implied",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary","functionality","tracking","targeting"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  ,
"language":"en"
  });
});
</script> 
  
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<!-- logo-animation.html -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const brandLink = document.querySelector(".navbar-brand");
    const logoImg = brandLink.querySelector("img.navbar-logo");
    const video = document.createElement("video");
    video.classList.add("navbar-logo", "video-logo");
    video.autoplay = true;
    video.muted = true;
    video.playsInline = true;
    video.loop = false;
    video.playbackRate = 1.0;

    const source = document.createElement("source");
    // Github Pages sites are served from a path like `https://arcadia-science.github.io/<repo>/`
    // so we need to add the repo name to the path when we're on Github Pages.
    const siteRoot = (window.location.hostname.endsWith('github.io')) ? `/${window.location.pathname.split('/')[1]}` : '';
    source.src = `${siteRoot}/assets/logo_movie.mp4`;
    source.type = "video/mp4";
    video.appendChild(source);

    // Function to handle video playback
    function handleVideoPlayback() {
      if (video.ended || video.paused) {
        video.currentTime = 0;
        video.playbackRate = 3.0;
        video.play().catch(e => console.log("Playback failed:", e));
      }
    }

    // Add hover event listener
    brandLink.addEventListener("mouseenter", handleVideoPlayback);

    // Handle visibility changes
    document.addEventListener("visibilitychange", function () {
      if (document.visibilityState === "visible") {
        handleVideoPlayback();
      }
    });

    // Handle page show (useful for mobile back button / screen unlock)
    window.addEventListener("pageshow", function (event) {
      if (event.persisted) {
        handleVideoPlayback();
      }
    });

    video.addEventListener("error", function () {
      console.error("Video playback error");
      logoImg.style.visibility = "visible";
      video.remove();
    });

    brandLink.appendChild(video);
  });
</script>
<template id="authors-template">
  <div class="authors-section">
    <button class="authors-toggle">
      <span class="authors-toggle-text">Show authors</span>
      <i class="bi bi-chevron-down authors-toggle-icon"></i>
    </button>
    <div class="authors-content quarto-title-meta-contents">
      <span class="author-order-indicator">(sorted A-Z)</span>
    </div>
  </div>
</template>

<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
<script>
  initAuthorReveal();

  function initAuthorReveal() {
    require.config({
      paths: {
        'js-yaml': 'https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min'
      }
    });

    require(['js-yaml'], function (jsyaml) {
      // Function to get last name from full name
      function getLastName(fullName) {
        const nameParts = fullName.trim().split(' ');
        return nameParts[nameParts.length - 1];
      }

      // Function to load the YAML file
      async function loadAuthorData() {
        try {
          // Github Pages sites are served from a path like `https://arcadia-science.github.io/<repo>/`
          // so we need to add the repo name to the path when we're on Github Pages.
          const siteRoot = (window.location.hostname.endsWith('github.io')) ? `/${window.location.pathname.split('/')[1]}` : '';
          const authorYamlPath = `${siteRoot}/authors.yml`;
          const response = await fetch(authorYamlPath);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const yamlText = await response.text();
          window.authorData = jsyaml.load(yamlText);
          initializeAuthors();
        } catch (error) {
          console.error('Error loading author data:', error);
        }
      }

      function initializeAuthors() {
        // Find the quarto-title-meta div
        const titleMeta = document.querySelector('.quarto-title-meta');
        if (!titleMeta) {
          return;
        }

        // Get template content
        const template = document.getElementById('authors-template');
        if (!template) {
          return;
        }
        const authorsSection = template.content.cloneNode(true);

        // Get the authors content div from the cloned template
        const authorsContent = authorsSection.querySelector('.authors-content');

        // Update sort to use last name
        const sortedAuthors = [...authorData.authors].sort((a, b) => {
          const lastNameA = getLastName(a.name);
          const lastNameB = getLastName(b.name);
          return lastNameA.localeCompare(lastNameB);
        });

        // Process authors from the data
        sortedAuthors.forEach(author => {
          const authorP = document.createElement('p');

          // Create name span
          const nameSpan = document.createElement('span');
          nameSpan.className = 'author-name';
          nameSpan.textContent = author.name;
          authorP.appendChild(nameSpan);

          // Add ORCID if present
          if (author.orcid) {
            const orcidLink = document.createElement('a');
            orcidLink.href = `https://orcid.org/${author.orcid}`;
            orcidLink.className = 'quarto-title-author-orcid';

            const orcidImage = document.createElement('img');
            orcidImage.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg==';
            orcidLink.appendChild(orcidImage);

            authorP.appendChild(orcidLink);
          }

          // Add to authors content
          authorsContent.appendChild(authorP);

          // Add tippy tooltip with roles if present
          if (author.roles) {
            const tooltipContent = `Roles: ${author.roles.map(r => r.charAt(0).toUpperCase() + r.slice(1)).join(', ')}`;
            tippy(nameSpan, {
              content: tooltipContent,
              allowHTML: true,
              placement: 'bottom',
              arrow: true,
              theme: 'custom'
            });
          }
        });

        // Create container and insert at the beginning of title meta
        const containerDiv = document.createElement('div');
        titleMeta.insertBefore(containerDiv, titleMeta.firstChild);
        containerDiv.appendChild(authorsSection);

        // Add toggle functionality
        const toggle = document.querySelector('.authors-toggle');
        const content = document.querySelector('.authors-content');

        if (!toggle || !content) {
          return;
        }

        toggle.addEventListener('click', () => {
          const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
          toggle.setAttribute('aria-expanded', !isExpanded);
          content.classList.toggle('is-visible');
        });

        // Initialize ARIA attributes
        toggle.setAttribute('aria-expanded', 'false');
        toggle.setAttribute('aria-controls', 'authors-content');
        content.setAttribute('id', 'authors-content');
      }

      // Start loading when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadAuthorData);
      } else {
        loadAuthorData();
      }
    });
  }
</script>
<template id="mini-title-template">
  <div class="mini-title page-columns page-full">
    <div class="mini-title-content">
      <div class="mini-title-logo-wrapper">
        <a href="https://research.arcadiascience.com/">
          <img class="logo-white" src="/assets/logo_white.png" alt="Logo">
        </a>
      </div>
      <p></p>
      <div id="mini-version-control"></div>
    </div>
  </div>
</template>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Get required elements
    const template = document.getElementById('mini-title-template');
    const titleBanner = document.querySelector('.quarto-title-banner');
    const abstract = document.querySelector('.abstract');
    const navbar = document.querySelector('#quarto-header');

    // Github Pages sites are served from a path like `https://arcadia-science.github.io/<repo>/`
    // so we need to add the repo name to the path when we're on Github Pages.
    const siteRoot = (window.location.hostname.endsWith('github.io')) ? `/${window.location.pathname.split('/')[1]}` : '';
    template.content.querySelector('.logo-white').src = `${siteRoot}/assets/logo_white.png`;

    let prevRatio = {appear: 1, disappear: 1};

    if (template && titleBanner && abstract && navbar) {
      // Add the mini title to the document body
      const miniTitleContent = document.importNode(template.content, true);
      document.body.appendChild(miniTitleContent);

      // Get and set the title text from h1.title
      const titleElement = document.querySelector('h1.title');
      const miniTitleP = document.querySelector('.mini-title-content p');
      if (titleElement && miniTitleP) {
        const titleText = titleElement.childNodes[0].textContent.trim();
        miniTitleP.textContent = titleText;

        // Only clone and add version control if title is not the demo title
        if (titleText !== 'A brief syntax demo') {
          // Clone version control dropdown if it exists
          const originalDropdown = document.querySelector('.navbar-nav .nav-item.dropdown:has(iconify-icon[icon="qlementine-icons:version-control-16"])');
          if (originalDropdown) {
            const clonedDropdown = originalDropdown.cloneNode(true);
            // Remove menu-text class but keep contents
            const menuTextSpan = clonedDropdown.querySelector('.menu-text');
            if (menuTextSpan) {
              menuTextSpan.classList.remove('menu-text');
            }
            // Add to mini version control container
            const versionContainer = document.querySelector('#mini-version-control');
            versionContainer.appendChild(clonedDropdown);
            // Initialize Bootstrap dropdown
            if (typeof bootstrap !== 'undefined') {
              const dropdownElement = clonedDropdown.querySelector('.dropdown-toggle');
              if (dropdownElement) {
                new bootstrap.Dropdown(dropdownElement);
              }
            }
          }
        }
      }

      const stickyMiniTitle = document.querySelector('.mini-title');

      // Navbar state management
      function updateNavbarState() {
        const isNavbarPinned = navbar.classList.contains('headroom--pinned');
        const isNavbarTop = !navbar.classList.contains('headroom--not-top');

        if (isNavbarPinned || isNavbarTop) {
          document.body.classList.add('navbar-visible');
        } else {
          document.body.classList.remove('navbar-visible');
        }
      }

      // Observe navbar class changes
      const navbarObserver = new MutationObserver(updateNavbarState);
      navbarObserver.observe(navbar, {
        attributes: true,
        attributeFilter: ['class']
      });
      updateNavbarState(); // Initial state

      // Mini title visibility functions
      function toggleMiniTitle(show) {
        document.body.classList.toggle('mini-title-visible', show);
        stickyMiniTitle.classList.toggle('visible', show);
      }

      // Create intersection observer with configurable options
      function createIntersectionObserver(type, rootMargin) {
        return new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            const currentRatio = entry.intersectionRatio;

            if (prevRatio[type] === 0 && currentRatio > 0) {
              toggleMiniTitle(false);
            } else if (prevRatio[type] > 0 && currentRatio === 0) {
              toggleMiniTitle(true);
            }

            prevRatio[type] = currentRatio;
          });
        }, {
          threshold: [0, 0.1],
          rootMargin
        });
      }

      // Create observers with different root margins
      const appearObserver = createIntersectionObserver('appear', '-48px');
      const disappearObserver = createIntersectionObserver('disappear', '48px');

      // Start observing title banner with both observers
      appearObserver.observe(titleBanner);
      disappearObserver.observe(titleBanner);

      // Cleanup
      window.addEventListener('beforeunload', () => {
        navbarObserver.disconnect();
        appearObserver.disconnect();
        disappearObserver.disconnect();
      });
    }
  });
</script>
<!-- version-in-title.html -->
<meta property="og:title" content="Cross-trait learning with a canonical transformer tops custom attention in genotype-phenotype mapping –">
<meta property="og:description" content="">
<meta property="og:image" content="https://Arcadia-Science.github.io/2025-geno-pheno-attention/assets/fig3.jpg">
<meta property="og:image:alt" content="Figure 3 from @Rijal2025 showing the single-environment model performances.">
<meta name="twitter:title" content="Cross-trait learning with a canonical transformer tops custom attention in genotype-phenotype mapping –">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="https://Arcadia-Science.github.io/2025-geno-pheno-attention/assets/fig3.jpg">
<meta name="twitter:image:alt" content="Figure 3 from @Rijal2025 showing the single-environment model performances.">
<meta name="twitter:card" content="summary_large_image">
</head><body class="nav-fixed quarto-light"><div id="title-version-control"></div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Find the original version control dropdown
    const originalDropdown = document.querySelector('.navbar-nav .nav-item.dropdown:has(iconify-icon[icon="qlementine-icons:version-control-16"])');
    if (originalDropdown && document.querySelector('.quarto-title')) {
      // Clone the dropdown structure
      const clonedDropdown = originalDropdown.cloneNode(true);
      // Update classes
      clonedDropdown.className = 'title-version-menu dropdown';
      // Remove the menu-text class but keep the span and its contents
      const menuTextSpan = clonedDropdown.querySelector('.menu-text');
      if (menuTextSpan) {
        menuTextSpan.classList.remove('menu-text');
      }
      // Find the title element
      const titleElement = document.querySelector('.quarto-title .title');
      if (titleElement) {
        // Add the version control to the container
        const versionContainer = document.getElementById('title-version-control');
        versionContainer.appendChild(clonedDropdown);
        titleElement.appendChild(versionContainer);

        // Check if this is the author guide and hide if it is
        if (titleElement.childNodes[0].textContent.trim() === 'A brief syntax demo') {
          versionContainer.style.display = 'none';
          versionContainer.style.visibility = 'hidden';
          versionContainer.style.pointerEvents = 'none';
        }

        // Ensure Bootstrap dropdown functionality works on the clone
        if (typeof bootstrap !== 'undefined') {
          const dropdownElement = clonedDropdown.querySelector('.dropdown-toggle');
          if (dropdownElement) {
            new bootstrap.Dropdown(dropdownElement);
          }
        }
      }
    }
  });
</script>
<!-- TODO: This solution currently generates the bibtex on the fly using a regex pattern. Ideally, the bibtex is a static file in the repository, similar to CITATION.cff. -->
<template id="citation-box-template">
  <div id="citation-popup" class="citation-popup">
    <div class="citation-popup-content">
      <div class="citation-header">
        <h4>Cite this pub</h4>
        <button id="close-citation-box" class="close-button" aria-label="Close citation box">×</button>
      </div>
      <div class="citation-tabs">
        <button class="citation-tab-button active" data-format="styled">Arcadia</button>
        <button class="citation-tab-button" data-format="bibtex">BibTeX</button>
      </div>
      <div class="citation-body">
        <div id="styled-citation" class="citation-content active">
          <p class="loading-text">Loading citation...</p>
        </div>
        <div id="bibtex-citation" class="citation-content">
          <pre class="loading-text">Loading citation...</pre>
        </div>
      </div>
      <div class="citation-footer">
        <button id="copy-citation-button" class="copy-button">
          <i class="bi bi-clipboard"></i> Copy to clipboard
        </button>
      </div>
    </div>
  </div>
</template>

<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
<script>
  // Initialize citation functionality after DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCitationBox);
  } else {
    initCitationBox();
  }

  function initCitationBox() {
    require.config({
      paths: {
        'js-yaml': 'https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min'
      }
    });

    require(['js-yaml'], function (jsyaml) {

      // Add citation box template to the document
      const template = document.getElementById('citation-box-template');
      const citationBoxContent = document.importNode(template.content, true);
      document.body.appendChild(citationBoxContent);

      // Find citation button
      const navLinks = document.querySelectorAll('.navbar-nav .nav-link');
      let citeButton = null;
      for (const link of navLinks) {
        if (link.textContent && link.textContent.trim() === 'Cite this pub') {
          citeButton = link;
          break;
        }
      }

      // Reference elements (assuming they exist in the template)
      const citationPopup = document.getElementById('citation-popup');
      const closeButton = document.getElementById('close-citation-box');
      const copyButton = document.getElementById('copy-citation-button');
      const tabButtons = document.querySelectorAll('.citation-tab-button');
      const styledEl = document.getElementById('styled-citation');
      const bibtexEl = document.getElementById('bibtex-citation');

      let pubData = {};
      let isDataLoaded = false;

      // --- Function to load the citation data ---
      async function loadCitationData() {
        // Set loading text (will be replaced on success)
        styledEl.innerHTML = `<p class="loading-text">Loading citation...</p>`;
        bibtexEl.innerHTML = `<pre class="loading-text">Loading citation...</pre>`;

        // Fetch and parse CFF
        const siteRoot = (window.location.hostname.endsWith('github.io')) ? `/${window.location.pathname.split('/')[1]}` : '';
        const citationCffPath = `${siteRoot}/CITATION.cff`;
        const response = await fetch(citationCffPath);
        const text = await response.text();
        const cffData = jsyaml.load(text);

        const preferredCitation = cffData['preferred-citation'];
        const title = preferredCitation.title;
        const year = preferredCitation.year;
        const doi = preferredCitation.doi;
        const authors = preferredCitation.authors;

        pubData = {
          title: String(title).trim(),
          year: String(year).trim(),
          doi: String(doi).trim(),
          authors: []
        };

        for (const author of authors) {
          pubData.authors.push({
            family: String(author['family-names']).trim(),
            given: String(author['given-names']).trim()
          });
        }

        updateCitations();
        isDataLoaded = true;
      }

      function updateCitations() {
        const url = pubData.doi ? `https://doi.org/${pubData.doi}` : window.location.href;

        // Text citation
        const styledAuthors = pubData.authors.map(author => {
          const initials = author.given.split(/\s+/).map(name => name.charAt(0)).join('');
          return `${author.family} ${initials}`;
        }).join(', ');
        styledEl.innerHTML = `<p>${styledAuthors}. (${pubData.year}). ${pubData.title}. ${url}</p>`;

        // BibTeX citation
        const firstAuthor = pubData.authors[0]; // Assume at least one author
        const bibtexKey = `${firstAuthor.family.replace(/[^a-zA-Z0-9]/g, '')}${pubData.year}${pubData.title.split(' ')[0].replace(/[^a-zA-Z0-9]/g, '')}`;
        const escapedTitle = pubData.title.replace(/([{}])/g, '\\$1');
        const titleWithCaps = escapedTitle.replace(/\b([A-Z][a-zA-Z0-9'-]*)\b/g, '{$1}');
        const bibtexAuthors = pubData.authors.map(author => `${author.family}, ${author.given}`).join(' and ');

        const bibtexContentFinal = `@article{${bibtexKey},
    author = {${bibtexAuthors}},
    title = {${titleWithCaps}},
    journal = {Arcadia Science},
    year = {${pubData.year}},${pubData.doi ? `\n    doi = {${pubData.doi}},` : ''}
    url = {${url}}
}`;
        bibtexEl.innerHTML = `<pre>${bibtexContentFinal}</pre>`;
      }

      // --- Function to toggle the citation box ---
      function toggleCitationBox() {
        const isVisible = citationPopup.classList.contains('visible');
        if (!isVisible) {
          citationPopup.classList.add('visible');
          // Load data only once on first open
          if (!isDataLoaded) {
            loadCitationData(); // Assuming this will succeed
          }
        } else {
          citationPopup.classList.remove('visible');
        }
      }

      // --- Event listeners ---
      citeButton.addEventListener('click', function (e) {
        e.preventDefault();
        toggleCitationBox();
      });

      closeButton.addEventListener('click', function () {
        citationPopup.classList.remove('visible');
      });

      // Tab switching
      tabButtons.forEach(button => {
        button.addEventListener('click', function () {
          tabButtons.forEach(btn => btn.classList.remove('active'));
          this.classList.add('active');
          document.querySelectorAll('.citation-content').forEach(content => {
            content.classList.remove('active');
          });
          const format = this.getAttribute('data-format');
          document.getElementById(`${format}-citation`).classList.add('active');
        });
      });

      // Copy to clipboard functionality
      copyButton.addEventListener('click', function () {
        const activeTab = document.querySelector('.citation-tab-button.active');
        const activeFormat = activeTab.getAttribute('data-format');
        const contentEl = document.getElementById(`${activeFormat}-citation`);

        let textToCopy = '';
        if (activeFormat === 'bibtex') {
          textToCopy = contentEl.querySelector('pre').textContent.trim();
        } else {
          textToCopy = contentEl.querySelector('p').textContent.trim();
        }

        navigator.clipboard.writeText(textToCopy)
          .then(() => {
            copyButton.innerHTML = '<i class="bi bi-check-lg"></i> Copied!';
            setTimeout(() => {
              copyButton.innerHTML = '<i class="bi bi-clipboard"></i> Copy to clipboard';
            }, 2000);
          })
          .catch(err => {
            console.error('Failed to copy text to clipboard: ', err);
            copyButton.innerHTML = '<i class="bi bi-x-lg"></i> Failed';
            setTimeout(() => {
              copyButton.innerHTML = '<i class="bi bi-clipboard"></i> Copy to clipboard';
            }, 2000);
          });
      });

      // Close on escape key
      document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
          if (citationPopup && citationPopup.classList.contains('visible')) {
            citationPopup.classList.remove('visible');
          }
        }
      });

    });
  }

</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="assets/css/main.css">
<link rel="stylesheet" href="assets/css/citation-box.css">




<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-xl " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="https://research.arcadiascience.com/" class="navbar-brand navbar-brand-logo">
    <img src="./assets/logo_text.png" alt="" class="navbar-logo">
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-iconify-qlementine-iconsversion-control-16-" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text"><iconify-icon role="img" inline="" icon="qlementine-icons:version-control-16" aria-label="Icon version-control-16 from qlementine-icons Iconify.design set." title="Icon version-control-16 from qlementine-icons Iconify.design set."></iconify-icon></span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-iconify-qlementine-iconsversion-control-16-">    
        <li>
    <a class="dropdown-item" href="./index.html">
 <span class="dropdown-text">v1.4 (latest)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./index_v1.3.html">
 <span class="dropdown-text">v1.3</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./index_v1.2.html">
 <span class="dropdown-text">v1.2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./index_v1.1.html">
 <span class="dropdown-text">v1.1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./index_v1.0.html">
 <span class="dropdown-text">v1.0</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text"><iconify-icon role="img" inline="" icon="nrk:back" aria-label="Icon back from nrk Iconify.design set." title="Icon back from nrk Iconify.design set."></iconify-icon> Back to Pub</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="./pages/FAQ.html"> 
<span class="menu-text">FAQ</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./pages/SETUP.html"> 
<span class="menu-text">Reproduce this pub</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./#"> 
<span class="menu-text">Cite this pub</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./pages/CONTRIBUTING.html"> 
<span class="menu-text">Contribute</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://twitter.com/arcadiascience" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-twitter-x"></i></a>
    <a href="https://github.com/Arcadia-Science/2025-geno-pheno-attention" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Cross-trait learning with a canonical transformer tops custom attention in genotype-phenotype mapping –</h1>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">April 30, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  <div>
    <div class="abstract">
      <div class="block-title">Summary</div>
      <p><span class="citation" data-cites="Rijal2025">Rijal et al. (<a href="#ref-Rijal2025" role="doc-biblioref">2025</a>)</span> recently applied attention mechanisms to the problem of mapping genotype to phenotype. We noted their architecture omitted standard transformer components, prompting us to test if including these elements could enhance performance on their multi-phenotype yeast dataset. Our analysis revealed that incorporating standard transformer elements substantially improves predictive accuracy for this task.</p>
    </div>
  </div>
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="2">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#the-dataset" id="toc-the-dataset" class="nav-link" data-scroll-target="#the-dataset">The dataset</a></li>
  <li><a href="#reproducing-single-phenotype-results" id="toc-reproducing-single-phenotype-results" class="nav-link" data-scroll-target="#reproducing-single-phenotype-results">Reproducing single phenotype results</a></li>
  <li><a href="#canonical-ml-components-outperform-bespoke-customization" id="toc-canonical-ml-components-outperform-bespoke-customization" class="nav-link" data-scroll-target="#canonical-ml-components-outperform-bespoke-customization">Canonical ML components outperform bespoke customization</a>
  <ul class="collapse">
  <li><a href="#why-predict-all-phenotypes-at-once" id="toc-why-predict-all-phenotypes-at-once" class="nav-link" data-scroll-target="#why-predict-all-phenotypes-at-once">Why predict all phenotypes at once?</a></li>
  <li><a href="#experimental-protocol" id="toc-experimental-protocol" class="nav-link" data-scroll-target="#experimental-protocol">Experimental protocol</a></li>
  </ul></li>
  <li><a href="#consistent-gains-across-phenotypes" id="toc-consistent-gains-across-phenotypes" class="nav-link" data-scroll-target="#consistent-gains-across-phenotypes">Consistent gains across phenotypes</a></li>
  <li><a href="#a-vanilla-transformer-architecture" id="toc-a-vanilla-transformer-architecture" class="nav-link" data-scroll-target="#a-vanilla-transformer-architecture">A vanilla transformer architecture</a></li>
  <li><a href="#conclusion-and-outlook" id="toc-conclusion-and-outlook" class="nav-link" data-scroll-target="#conclusion-and-outlook">Conclusion and outlook</a>
  <ul class="collapse">
  <li><a href="#why-multi-output-matters" id="toc-why-multi-output-matters" class="nav-link" data-scroll-target="#why-multi-output-matters">Why multi-output matters</a></li>
  <li><a href="#a-foundation-not-a-finish-line" id="toc-a-foundation-not-a-finish-line" class="nav-link" data-scroll-target="#a-foundation-not-a-finish-line">A foundation, not a finish line</a></li>
  <li><a href="#an-invitation-to-build-further" id="toc-an-invitation-to-build-further" class="nav-link" data-scroll-target="#an-invitation-to-build-further">An invitation to build further</a></li>
  </ul></li>
  <li><a href="#appendix-a-codebase-primer" id="toc-appendix-a-codebase-primer" class="nav-link" data-scroll-target="#appendix-a-codebase-primer">Appendix: a codebase primer</a>
  <ul class="collapse">
  <li><a href="#training-models" id="toc-training-models" class="nav-link" data-scroll-target="#training-models">Training models</a></li>
  <li><a href="#distributed-computing" id="toc-distributed-computing" class="nav-link" data-scroll-target="#distributed-computing">Distributed computing</a></li>
  <li><a href="#caching-behavior" id="toc-caching-behavior" class="nav-link" data-scroll-target="#caching-behavior">Caching behavior</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">





<div class="callout callout-style-default callout-note callout-titled" title="AI usage disclosure">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
AI usage disclosure
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>We used Claude to help write code and clean up code. We used ChatGPT to help write code, clean up code, write text that we edited, suggest wording ideas and then chose which small phrases or sentence structure ideas to use, expand on summary text that we provided and then edited the text it produced, help clarify and streamline text that we wrote, interpret model training results data, and suggest papers on relevant science, we did further reading, and we cited some of this literature. We also provided ChatGPT with starting text and had it rearrange that text to fit the structure of one of our pub templates. We used Gemini in similar ways to help write code, clean up code, write text that we edited, suggest wording ideas and then chose which small phrases or sentence structure ideas to use, help clarify and streamline text that we wrote, interpret model training results data, and suggest papers on relevant science, we did further reading, and we cited some of this literature. We also provided Gemini with starting text and had it rearrange that text to fit the structure of one of our pub templates, and expanded on summary text that we provided and then edited the text it produced.</p>
</div>
</div>
</div>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>On April 11th, <span class="citation" data-cites="Rijal2025">Rijal et al. (<a href="#ref-Rijal2025" role="doc-biblioref">2025</a>)</span> released a preprint that introduces an application of attention mechanisms for inferring genotype-phenotype maps, particularly focusing on capturing complex epistatic interactions. This work sparked considerable interest given our ongoing exploration of nonlinear genotype-phenotype models.</p>
<p>By training on 100,000 yeast segregants over 18 growth phenotypes, <span class="citation" data-cites="Rijal2025">Rijal et al. (<a href="#ref-Rijal2025" role="doc-biblioref">2025</a>)</span> demonstrated that an attention-based architecture extracts more epistatic signals than conventional linear methods, and does so with far fewer parameters than the full second-order regression that has become a norm in quantitative genetics. Their study therefore provides an important proof-of-principle for deep-learning architectures being able to cope with linkage disequilibrium, noise, and sparse high-order interactions in large-scale genotype-phenotype data.</p>
<p>That success naturally raised our curiosity. The network they used omits several standard transformer components that brought attention into the limelight: skip connections, layer normalisation, and feed-forward sub-layers <span class="citation" data-cites="Vaswani2017">(<a href="#ref-Vaswani2017" role="doc-biblioref">Vaswani et al., 2017</a>)</span>. Given the cross-domain success that transformers have seen, we wondered: <strong>Could the performance be further improved by replacing their model with a standard “vanilla” transformer architecture?</strong> We found out. Also, along the way, we uncovered a missed opportunity by <span class="citation" data-cites="Rijal2025">Rijal et al. (<a href="#ref-Rijal2025" role="doc-biblioref">2025</a>)</span> to reinforce the learning signal by properly leveraging cross-phenotype genetic correlations, which led to significant performance gains.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<iconify-icon role="img" inline="" icon="fxemoji:lightningmood" aria-label="Icon lightningmood from fxemoji Iconify.design set." title="Icon lightningmood from fxemoji Iconify.design set."></iconify-icon> Lightning fast shareable research
</div>
</div>
<div class="callout-body-container callout-body">
<p>We offer this work not just as a technical add-on but as a proof of how open, fast-moving collaboration can accelerate discovery. <span class="citation" data-cites="Rijal2025">Rijal et al. (<a href="#ref-Rijal2025" role="doc-biblioref">2025</a>)</span> shared their code and within twenty days of their preprint—and after only nine working days—we were able to validate, extend, and publicly release the next iteration. That cycle is orders of magnitude quicker than the traditional journal pipeline and illustrates the compounding value of doing bio ML in the open. We hope the present study sparks yet another round of improvements.</p>
</div>
</div>
</section>
<section id="the-dataset" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="the-dataset">The dataset</h2>
<p>The experimental data used in <span class="citation" data-cites="Rijal2025">Rijal et al. (<a href="#ref-Rijal2025" role="doc-biblioref">2025</a>)</span> comes from the work of <span class="citation" data-cites="Ba2022">Nguyen Ba et al. (<a href="#ref-Ba2022" role="doc-biblioref">2022</a>)</span>, who performed a large-scale quantitative trait locus (QTL) study in yeast. In short, they measured the growth rates of ~100,000 yeast segregants across 18 conditions and for ~40,000 loci, creating a massive dataset suitable for mapping genotype to phenotype.</p>
<p>Due to extensive linkage disequilibrium (LD), the loci in the dataset are highly correlated with each other. To create a set of independent loci, <span class="citation" data-cites="Rijal2025">Rijal et al. (<a href="#ref-Rijal2025" role="doc-biblioref">2025</a>)</span> defined a set of loci such that the correlation between the SNPs present at any pair of loci is less than 94%, resulting in a set of 1164 “independent” loci.</p>
<p>We were unable to find the set of loci, nor the genotypic and phenotypic data used for training, so we located the <a href="https://datadryad.org/dataset/doi:10.5061/dryad.1rn8pk0vd">raw data</a> that <span class="citation" data-cites="Ba2022">Nguyen Ba et al. (<a href="#ref-Ba2022" role="doc-biblioref">2022</a>)</span> originally uploaded alongside their study, then used <a href="https://github.com/Emergent-Behaviors-in-Biology/GenoPhenoMapAttention/blob/main/obtain_independent_loci.ipynb">this notebook</a> uploaded by <span class="citation" data-cites="Rijal2025">Rijal et al. (<a href="#ref-Rijal2025" role="doc-biblioref">2025</a>)</span> to recapitulate the 1164 loci. To save everyone else the trouble, we uploaded the train, test, and validation datasets we’re <em>pretty sure</em> <span class="citation" data-cites="Rijal2025">Rijal et al. (<a href="#ref-Rijal2025" role="doc-biblioref">2025</a>)</span> used in their study.</p>
<p>You can find the data here: <a href="https://zenodo.org/records/15313069">https://zenodo.org/records/15313069</a></p>
<p>We’ll use this data in what follows, so let’s go ahead and download it into the current working directory:</p>
<div id="81c4e7b1" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>dataset_dir <span class="op">=</span> Path(<span class="st">"datasets/"</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> dataset_dir.exists():</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    zenodo_url <span class="op">=</span> <span class="st">"https://zenodo.org/records/15313069/files/datasets.zip"</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    subprocess.run([<span class="st">"wget"</span>, zenodo_url])</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    subprocess.run([<span class="st">"unzip"</span>, <span class="st">"datasets.zip"</span>])</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    Path(<span class="st">"datasets.zip"</span>).unlink()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell page-columns page-full" data-tbl-cap="Table 1. The test dataset $R^2$ values for the attention model in Figure 3 of Rijal et al. Calculated by manual pixel counting." data-execution_count="2">

<div class="no-row-height column-margin column-container"><div class="cell-output cell-output-display" data-execution_count="2">
<div>

<table class="dataframe table table-sm table-striped small"><caption><p>Table 1. The test dataset <span class="math inline"><em>R</em><sup>2</sup></span> values for the
attention model in Figure 3 of Rijal et al. Calculated by manual pixel
counting.</p> {#8d4b415c}</caption>
  <thead>
    <tr>
      <th></th>
      <th>Phenotype</th>
      <th>Source R²</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>23C</td>
      <td>0.612</td>
    </tr>
    <tr>
      <th>1</th>
      <td>25C</td>
      <td>0.621</td>
    </tr>
    <tr>
      <th>2</th>
      <td>27C</td>
      <td>0.632</td>
    </tr>
    <tr>
      <th>3</th>
      <td>30C</td>
      <td>0.609</td>
    </tr>
    <tr>
      <th>4</th>
      <td>33C</td>
      <td>0.615</td>
    </tr>
    <tr>
      <th>5</th>
      <td>35C</td>
      <td>0.582</td>
    </tr>
    <tr>
      <th>6</th>
      <td>37C</td>
      <td>0.566</td>
    </tr>
    <tr>
      <th>7</th>
      <td>cu</td>
      <td>0.610</td>
    </tr>
    <tr>
      <th>8</th>
      <td>suloc</td>
      <td>0.638</td>
    </tr>
    <tr>
      <th>9</th>
      <td>ynb</td>
      <td>0.487</td>
    </tr>
    <tr>
      <th>10</th>
      <td>eth</td>
      <td>0.604</td>
    </tr>
    <tr>
      <th>11</th>
      <td>gu</td>
      <td>0.566</td>
    </tr>
    <tr>
      <th>12</th>
      <td>li</td>
      <td>0.630</td>
    </tr>
    <tr>
      <th>13</th>
      <td>mann</td>
      <td>0.600</td>
    </tr>
    <tr>
      <th>14</th>
      <td>mol</td>
      <td>0.618</td>
    </tr>
    <tr>
      <th>15</th>
      <td>raff</td>
      <td>0.653</td>
    </tr>
    <tr>
      <th>16</th>
      <td>sds</td>
      <td>0.630</td>
    </tr>
    <tr>
      <th>17</th>
      <td>4NQO</td>
      <td>0.609</td>
    </tr>
  </tbody>
</table>
</div>
</div></div></div>
</section>
<section id="reproducing-single-phenotype-results" class="level2">
<h2 class="anchored" data-anchor-id="reproducing-single-phenotype-results">Reproducing single phenotype results</h2>
<p>Let’s first try and reproduce the single-phenotype attention model performances observed in Figure 3 (red dots). This will give us the confidence to know we both <strong>(a)</strong> correctly reverse-engineered the specifics of their training/validation/test datasets and <strong>(b)</strong> accurately implemented their model.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="assets/fig3.jpg" class="img-fluid figure-img" style="width:100.0%" alt="Figure 3 from @Rijal2025 showing the single-environment model performances."></p>
<figcaption>Figure 3 from <span class="citation" data-cites="Rijal2025">Rijal et al. (<a href="#ref-Rijal2025" role="doc-biblioref">2025</a>)</span>. Original caption: “<em>Comparison of model performance in yeast QTL mapping data. We show R² on test datasets for linear, linear+pairwise, and attention-based model (with d = 12) across 18 phenotypes (relative growth rates in various environments). For the linear + pairwise mode, the causal loci inferred by <span class="citation" data-cites="Ba2022">Nguyen Ba et al. (<a href="#ref-Ba2022" role="doc-biblioref">2022</a>)</span> are used.</em>”</figcaption>
</figure>
</div>
<p>Note that a separate model is trained on each phenotype, so reproducing this figure involves training 18 models. To do this, we need to create config objects specifying each model architecture and how the training should proceed.</p>
<div id="27f1bc0f" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> attrs</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> analysis.base <span class="im">import</span> ModelConfig, TrainConfig</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> analysis.dataset <span class="im">import</span> phenotype_names</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>model_config <span class="op">=</span> ModelConfig(</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    model_type<span class="op">=</span><span class="st">"rijal_et_al"</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    seq_length<span class="op">=</span><span class="dv">1164</span>,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    embedding_dim<span class="op">=</span><span class="dv">13</span>,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    num_layers<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co"># This template config sets all the shared parameters.</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>train_template_config <span class="op">=</span> TrainConfig(</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    data_dir<span class="op">=</span>dataset_dir,</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    save_dir<span class="op">=</span>Path(<span class="st">"models/fig3"</span>),</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    name_prefix<span class="op">=</span><span class="st">"fig3_23C"</span>,</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    phenotypes<span class="op">=</span>[<span class="st">"23C"</span>],</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    optimizer<span class="op">=</span><span class="st">"adam"</span>,</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span><span class="dv">64</span>,</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    learning_rate<span class="op">=</span><span class="fl">0.001</span>,</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    lr_schedule<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    weight_decay<span class="op">=</span><span class="fl">0.0</span>,</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    max_epochs<span class="op">=</span><span class="dv">200</span>,</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    gradient_clip_val<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    use_cache<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    use_modal<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>jobs <span class="op">=</span> []</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> phenotype <span class="kw">in</span> phenotype_names:</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Each train config needs to set its corresponding phenotype(s).</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    phenotype_config <span class="op">=</span> attrs.evolve(</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>        train_template_config, phenotypes<span class="op">=</span>[phenotype], name_prefix<span class="op">=</span><span class="ss">f"fig3_</span><span class="sc">{</span>phenotype<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    jobs.append((model_config, phenotype_config))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>With each job properly configured, we can train a model for each phenotype:</p>
<div id="1b8c4b90" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> analysis.train <span class="im">import</span> run_trainings</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>model_dirs <span class="op">=</span> run_trainings(jobs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Pre-trained model 'fig3_23C' found. Returning path.
Pre-trained model 'fig3_25C' found. Returning path.
Pre-trained model 'fig3_27C' found. Returning path.
Pre-trained model 'fig3_30C' found. Returning path.
Pre-trained model 'fig3_33C' found. Returning path.
Pre-trained model 'fig3_35C' found. Returning path.
Pre-trained model 'fig3_37C' found. Returning path.
Pre-trained model 'fig3_cu' found. Returning path.
Pre-trained model 'fig3_suloc' found. Returning path.
Pre-trained model 'fig3_ynb' found. Returning path.
Pre-trained model 'fig3_eth' found. Returning path.
Pre-trained model 'fig3_gu' found. Returning path.
Pre-trained model 'fig3_li' found. Returning path.
Pre-trained model 'fig3_mann' found. Returning path.
Pre-trained model 'fig3_mol' found. Returning path.
Pre-trained model 'fig3_raff' found. Returning path.
Pre-trained model 'fig3_sds' found. Returning path.
Pre-trained model 'fig3_4NQO' found. Returning path.</code></pre>
</div>
</div>
<div class="callout callout-style-simple callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
A note about training behavior
</div>
</div>
<div class="callout-body-container callout-body">
<p>The above code will initiate training for all configured jobs, with important considerations:</p>
<ul>
<li>Caching: Since <code>train_config.use_cache = True</code> and these models are stored in the GitHub repository, executing this locally will use cached models instead of performing expensive retraining</li>
<li>Training Duration: Each training job takes approximately 2.5 hours to complete on an A10G GPU, so running all jobs without caching would require significant time</li>
<li>Compute Configuration: In our production environment, we set <code>train_config.use_modal = True</code> to distribute compute jobs via <a href="https://modal.com/">Modal</a>. For compatibility with different compute architectures, this notebook uses <code>train_config.use_modal = False</code> by default.</li>
</ul>
</div>
</div>
<p>Inside each run directory is a <code>metrics.csv</code> that we can get the test dataset <span class="math inline">\(R^2\)</span> from and compare directly against Figure 3 from <span class="citation" data-cites="Rijal2025">Rijal et al. (<a href="#ref-Rijal2025" role="doc-biblioref">2025</a>)</span>.</p>
<div id="cell-fig-rep" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> arcadia_pycolor <span class="im">as</span> apc</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib <span class="im">as</span> mpl</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>apc.mpl.setup()</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_test_r2(model_dir: Path) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> pd.read_csv(model_dir <span class="op">/</span> <span class="st">"metrics.csv"</span>)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">float</span>(metrics.loc[metrics[<span class="st">"metric"</span>] <span class="op">==</span> <span class="st">"test_r2"</span>, <span class="st">"value"</span>].iloc[<span class="dv">0</span>])</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>fig3_reproduction_r2 <span class="op">=</span> [get_test_r2(d) <span class="cf">for</span> d <span class="kw">in</span> model_dirs]</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>fig3_results[<span class="st">"reproduction R2"</span>] <span class="op">=</span> fig3_reproduction_r2</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(fig3_results)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.arange(<span class="bu">len</span>(df))</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>width <span class="op">=</span> <span class="fl">0.35</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mpl.rc_context({<span class="st">"figure.facecolor"</span>: apc.parchment}):</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    plt.figure(dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    plt.bar(x <span class="op">-</span> width <span class="op">/</span> <span class="dv">2</span>, df[<span class="st">"source R2"</span>], width, label<span class="op">=</span><span class="st">"Source R²"</span>, color<span class="op">=</span>apc.cloud)</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    plt.bar(x <span class="op">+</span> width <span class="op">/</span> <span class="dv">2</span>, df[<span class="st">"reproduction R2"</span>], width, label<span class="op">=</span><span class="st">"Reproduction R²"</span>, color<span class="op">=</span>apc.steel)</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">"Phenotype"</span>)</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">"R² Score"</span>)</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    plt.ylim(<span class="fl">0.46</span>, <span class="fl">0.67</span>)</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    plt.xticks(x, df[<span class="st">"phenotype"</span>], rotation<span class="op">=</span><span class="dv">90</span>)</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    plt.legend(loc<span class="op">=</span>(<span class="fl">0.05</span>, <span class="fl">0.90</span>), ncol<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-rep" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-rep-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_v1.2_files/figure-html/fig-rep-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-rep-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Comparison of test-set <span class="math inline">\(R^2\)</span> values between <span class="citation" data-cites="Rijal2025">Rijal et al. (<a href="#ref-Rijal2025" role="doc-biblioref">2025</a>)</span> (“Source”) and our re-implementation (“Reproduction”).
</figcaption>
</figure>
</div>
</div>
</div>
<p>With an <span class="math inline">\(n\)</span> of 1, we can’t assess reproducibility rigorously. Even so, our re-implementation matches the published numbers very closely. Here are some numbers on the phenotype with the largest deviation:</p>
<div id="9d96d37f" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>deltas <span class="op">=</span> (df[<span class="st">"source R2"</span>] <span class="op">-</span> df[<span class="st">"reproduction R2"</span>]).<span class="bu">abs</span>()</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>max_idx <span class="op">=</span> deltas.argmax()</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>max_delta <span class="op">=</span> deltas.<span class="bu">max</span>()</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>phenotype_with_largest_delta <span class="op">=</span> df[<span class="st">"phenotype"</span>].iloc[max_idx]</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>percent_diff <span class="op">=</span> <span class="dv">100</span> <span class="op">*</span> max_delta <span class="op">/</span> df[<span class="st">"source R2"</span>].iloc[max_idx]</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Biggest discrepenacy:"</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"- Phenotype: </span><span class="sc">{</span>phenotype_with_largest_delta<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"- R2 difference: </span><span class="sc">{</span>max_delta<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"- Percent difference: </span><span class="sc">{</span>percent_diff<span class="sc">:.1f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Biggest discrepenacy:
- Phenotype: 33C
- R2 difference: 0.008
- Percent difference: 1.3</code></pre>
</div>
</div>
<p>Overall, these results help assure us that:</p>
<ol type="1">
<li>The train/validation/test partitions are identical, or at least functionally equivalent</li>
<li>Our code reproduces the authors’ architecture and training procedure.</li>
</ol>
<p>With this validated baseline in place, we’re now confident in using it as the starting point for modifying the architecture.</p>
</section>
<section id="canonical-ml-components-outperform-bespoke-customization" class="level2">
<h2 class="anchored" data-anchor-id="canonical-ml-components-outperform-bespoke-customization">Canonical ML components outperform bespoke customization</h2>
<p>The <span class="citation" data-cites="Rijal2025">Rijal et al. (<a href="#ref-Rijal2025" role="doc-biblioref">2025</a>)</span> model architecture uses non-standard components. To test whether these idiosyncratic choices are actually helpful, we replaced each one with a standard, “textbook” alternative and measured the collective impact on predictive accuracy.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 45%">
<col style="width: 16%">
<col style="width: 37%">
</colgroup>
<thead>
<tr class="header">
<th>Non-standard element in Rijal <em>et al.</em></th>
<th>What it does</th>
<th>Canonical replacement we tried</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Random projection of a diagonal genotype matrix</strong> <code>X(g)·R</code></td>
<td>Encodes each locus as a row of a fixed random matrix <code>R</code>, multiplied by the allele sign (±1).</td>
<td>A learned embedding table <code>nn.Embedding(L, D)</code> whose rows are multiplied by the allele sign.</td>
</tr>
<tr class="even">
<td><strong>Concatenated column of ones</strong></td>
<td>Appends a constant 1 to every token to mimic an explicit bias term (Appendix F in the original paper).</td>
<td>Simply enable the bias in the linear Q, K, V projections (<code>nn.Linear(..., bias=True)</code>).</td>
</tr>
<tr class="odd">
<td><strong>Phenotype represented as an <em>input</em> token</strong></td>
<td>Adds one-hot phenotype tokens to the sequence, forcing attention layers to discover gene × phenotype interactions.</td>
<td>Condition the model <em>after</em> the attention block: predict all phenotypes jointly from a pooled sequence representation (see below).</td>
</tr>
<tr class="even">
<td><strong>Flattened fitness matrix</strong></td>
<td>Treats each (genotype, phenotype) pair as an independent sample; the network outputs one scalar at a time.</td>
<td>Mean-pool the token embeddings → <code>(B, D)</code> and use a single linear layer <code>D → 18</code> so all phenotypes are predicted simultaneously.</td>
</tr>
</tbody>
</table>
<section id="why-predict-all-phenotypes-at-once" class="level3">
<h3 class="anchored" data-anchor-id="why-predict-all-phenotypes-at-once">Why predict all phenotypes at once?</h3>
<p>The measured phenotypes are likely to be genetically correlated due to biological processes such as pleiotropy. Consequently, knowing that a mutation hurts growth in one condition has the potential to inform its effect in another. A shared output head lets the network exploit this mutual information, whereas the original set-up can only share knowledge through the shared attention weights. Our phenotype-phenotype autoencoder study <span class="citation" data-cites="Avasthi2023">(<a href="#ref-Avasthi2023" role="doc-biblioref">Avasthi et al., 2023</a>)</span> showed significant prediction benefits when accounting for phenotypic covariation, so we’re expecting the same thing to be true here, too.</p>
</section>
<section id="experimental-protocol" class="level3">
<h3 class="anchored" data-anchor-id="experimental-protocol">Experimental protocol</h3>
<p>The codebase contains a new architecture with the above modifications. Let’s test its performance with the following changes to the training:</p>
<ul>
<li>Increase the number of phenotypes from <span class="math inline">\(1\)</span> to <span class="math inline">\(18\)</span> (all).</li>
<li>Correspondingly increase the hidden dimension from <span class="math inline">\(d=12\)</span> to <span class="math inline">\(d=128\)</span>.</li>
<li>Decrease the learning rate 10-fold, from <span class="math inline">\(1 \times 10^{-3}\)</span> to <span class="math inline">\(1 \times 10^{-4}\)</span>.</li>
</ul>
<p>Finally, because <a href="#fig-rep" class="quarto-xref">Figure&nbsp;1</a> hints at potentially significant run-to-run variance, let’s run five replicates, where each replicate differs only in its initializing seed (the train/validation/test splits are held constant).</p>
<div id="3ac9eb98" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>NUM_REPLICATES <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>jobs <span class="op">=</span> []</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(NUM_REPLICATES):</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    replicate_id <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>i<span class="sc">:02d}</span><span class="ss">"</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    job_name_prefix <span class="op">=</span> <span class="ss">f"std_d128_rep_</span><span class="sc">{</span>replicate_id<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    model_config <span class="op">=</span> ModelConfig(</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>        embedding_dim<span class="op">=</span><span class="dv">128</span>,</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        model_type<span class="op">=</span><span class="st">"modified"</span>,</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        seq_length<span class="op">=</span><span class="dv">1164</span>,</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        num_layers<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    train_config <span class="op">=</span> attrs.evolve(</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        train_template_config,</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>        save_dir<span class="op">=</span>Path(<span class="st">"models/canonical"</span>),</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>        phenotypes<span class="op">=</span>phenotype_names,</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>        name_prefix<span class="op">=</span>job_name_prefix,</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>        optimizer<span class="op">=</span><span class="st">"adamw"</span>,</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>        max_epochs<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    jobs.append((model_config, train_config))</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Generated </span><span class="sc">{</span><span class="bu">len</span>(jobs)<span class="sc">}</span><span class="ss"> job configurations."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Generated 5 job configurations.</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you’re running this yourself and aren’t interested in replicates, you can reduce the amount of required compute by setting <code>NUM_REPLICATES</code> in the above cell to 1.</p>
</div>
</div>
<p>Now, let’s run the experiment:</p>
<div id="b2e6f770" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>model_dirs <span class="op">=</span> run_trainings(jobs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Pre-trained model 'std_d128_rep_00' found. Returning path.
Pre-trained model 'std_d128_rep_01' found. Returning path.
Pre-trained model 'std_d128_rep_02' found. Returning path.
Pre-trained model 'std_d128_rep_03' found. Returning path.
Pre-trained model 'std_d128_rep_04' found. Returning path.</code></pre>
</div>
</div>
</section>
</section>
<section id="consistent-gains-across-phenotypes" class="level2">
<h2 class="anchored" data-anchor-id="consistent-gains-across-phenotypes">Consistent gains across phenotypes</h2>
<p><a href="#fig-std" class="quarto-xref">Figure&nbsp;2</a> shows that swapping the custom choices in <span class="citation" data-cites="Rijal2025">Rijal et al. (<a href="#ref-Rijal2025" role="doc-biblioref">2025</a>)</span> for a canonical <em>embedding <span class="math inline">\(\rightarrow\)</span> mean-pool <span class="math inline">\(\rightarrow\)</span> linear-head</em> model and predicting all 18 phenotypes jointly yields a boost in predictive power across the board:</p>
<div id="cell-fig-std" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>label_lookup <span class="op">=</span> {</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"std"</span>: <span class="st">"Canonical"</span>,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_phenotype_r2_data(model_dir: Path) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine the architecture and replicate number from model directory name</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    dir_name <span class="op">=</span> model_dir.parent.parent.name  <span class="co"># e.g., "std_d128_rep_09"</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    variant_key, _, rep_str <span class="op">=</span> dir_name.rpartition(<span class="st">"_rep_"</span>)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    base_arch_key, _, _ <span class="op">=</span> variant_key.rpartition(<span class="st">"_d"</span>)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    architecture_label <span class="op">=</span> label_lookup[base_arch_key]</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load and wrangle the metrics.csv. Keep only the per-phenotype test R2 values.</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(model_dir <span class="op">/</span> <span class="st">"metrics.csv"</span>)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df[df[<span class="st">"metric"</span>].<span class="bu">str</span>.startswith(<span class="st">"test_r2_"</span>)]</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"phenotype"</span>] <span class="op">=</span> df[<span class="st">"metric"</span>].<span class="bu">str</span>[<span class="dv">8</span>:]</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    df.drop(<span class="st">"metric"</span>, axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    df.rename(columns<span class="op">=</span>{<span class="st">"value"</span>: <span class="st">"r2"</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"architecture"</span>] <span class="op">=</span> architecture_label</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"replicate"</span>] <span class="op">=</span> <span class="bu">int</span>(rep_str)</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"r2"</span>] <span class="op">=</span> df[<span class="st">"r2"</span>].astype(<span class="bu">float</span>)</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Concat the phenotype data across all models</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>canonical_plot_data <span class="op">=</span> pd.concat([get_phenotype_r2_data(model_dir) <span class="cf">for</span> model_dir <span class="kw">in</span> model_dirs])</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the mean and standard error R2 over replicates</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>canonical_plot_data <span class="op">=</span> (</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    canonical_plot_data.groupby([<span class="st">"architecture"</span>, <span class="st">"phenotype"</span>])[<span class="st">"r2"</span>]</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>    .agg(mean_r2<span class="op">=</span><span class="st">"mean"</span>, std_r2<span class="op">=</span><span class="st">"std"</span>)</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Concatenate the manually scraped Fig3 R2s</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>rijal_r2s <span class="op">=</span> fig3_results.copy(deep<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>rijal_r2s.drop(<span class="st">"reproduction R2"</span>, axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>rijal_r2s.rename(columns<span class="op">=</span>{<span class="st">"source R2"</span>: <span class="st">"mean_r2"</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>rijal_r2s[<span class="st">"std_r2"</span>] <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>rijal_r2s[<span class="st">"architecture"</span>] <span class="op">=</span> <span class="st">"Rijal"</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>canonical_plot_data <span class="op">=</span> pd.concat([canonical_plot_data, rijal_r2s])</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting code.</span></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>canonical_plot_data[<span class="st">"phenotype"</span>] <span class="op">=</span> pd.Categorical(</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>    canonical_plot_data[<span class="st">"phenotype"</span>], categories<span class="op">=</span>phenotype_names, ordered<span class="op">=</span><span class="va">True</span></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>arch_order <span class="op">=</span> [<span class="st">"Rijal"</span>, <span class="st">"Canonical"</span>]</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.arange(<span class="bu">len</span>(phenotype_names))</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>width <span class="op">=</span> <span class="fl">0.25</span></span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>color_map <span class="op">=</span> {</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Rijal"</span>: apc.cloud,</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Canonical"</span>: apc.mars,</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mpl.rc_context({<span class="st">"figure.facecolor"</span>: apc.parchment}):</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>    plt.figure(dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, arch <span class="kw">in</span> <span class="bu">enumerate</span>(arch_order):</span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>        sub <span class="op">=</span> (</span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>            canonical_plot_data[canonical_plot_data[<span class="st">"architecture"</span>] <span class="op">==</span> arch]</span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>            .set_index(<span class="st">"phenotype"</span>)</span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>            .reindex(phenotype_names)</span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>        plt.bar(</span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>            x <span class="op">+</span> (i <span class="op">-</span> <span class="fl">0.5</span>) <span class="op">*</span> width,  <span class="co"># centre bars around tick</span></span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>            sub[<span class="st">"mean_r2"</span>],</span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a>            width,</span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>            yerr<span class="op">=</span>sub[<span class="st">"std_r2"</span>],</span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a>            ecolor<span class="op">=</span><span class="st">"#00000099"</span>,</span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a>            error_kw<span class="op">=</span><span class="bu">dict</span>(elinewidth<span class="op">=</span><span class="fl">1.5</span>),</span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span>arch,</span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>color_map[arch],</span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a>    plt.xticks(x, phenotype_names, rotation<span class="op">=</span><span class="dv">90</span>)</span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">"Phenotype"</span>)</span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">"Mean $R^2$ (± SD)"</span>)</span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a>    plt.ylim(<span class="fl">0.43</span>, <span class="fl">0.69</span>)</span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a>    plt.legend(loc<span class="op">=</span>(<span class="fl">0.05</span>, <span class="fl">0.92</span>), ncol<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-std" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-std-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_v1.2_files/figure-html/fig-std-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-std-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Per-phenotype generalisation of multi-task vs.&nbsp;single-task models. Bar heights show the mean test-set <span class="math inline">\(R^{2}\)</span> achieved across replicates for each phenotype, with error bars denoting the standard deviation (SD). “Rijal” is the single-phenotype results reported in <span class="citation" data-cites="Rijal2025">Rijal et al. (<a href="#ref-Rijal2025" role="doc-biblioref">2025</a>)</span>, while “Canonical” is our multi-output head trained to predict all phenotypes jointly.
</figcaption>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important caveat on the baseline we compare against
</div>
</div>
<div class="callout-body-container callout-body">
<p>The numbers labeled “Rijal” in <a href="#fig-std" class="quarto-xref">Figure&nbsp;2</a> come from the single-phenotype models reported in their Figure 3. <span class="citation" data-cites="Rijal2025">Rijal et al. (<a href="#ref-Rijal2025" role="doc-biblioref">2025</a>)</span> do develop a multi-phenotype architecture, but careful inspection of <a href="https://github.com/Emergent-Behaviors-in-Biology/GenoPhenoMapAttention/blob/main/experiment/multi_env_attention_QTL_yeast_data.ipynb">their code</a> shows that it still emits a scalar output per forward pass and simply loops over phenotypes at train time. In other words, each (genotype, phenotype) pair is treated as an independent sample. The predictive power of this model is shown in their Figure 4, and is actually worse than the single-phenotype models at predicting any given phenotype.</p>
<p>Because our goal is to test whether a genuine multi-output head + canonical components confer an advantage, we chose the best-performing baseline available (their single-phenotype models). The comparison is therefore conservative: any gains we report would be larger, not smaller, if the authors’ scalar multi-phenotype model were used as the reference.</p>
</div>
</div>
<p>Quantifying which changes contributed to these gains would require an ablation study, however our hunch is that the primary gains come from cross-phenotype genetic correlations. For instance we note that some of the most consistent gains we see in our implementation of the model come from fitness measurements at different temperatures, a set of phenotypes that is almost certainly impacted by pleiotropic sets of genes. Joint training allows the network to transfer information among genetically correlated traits, an advantage that the single-output baseline can’t exploit beyond implicit relationships learned through shared attention weights.</p>
<p>Taken together, these results validate the canonical multi-output model as a stronger starting point than the original design.</p>
</section>
<section id="a-vanilla-transformer-architecture" class="level2">
<h2 class="anchored" data-anchor-id="a-vanilla-transformer-architecture">A vanilla transformer architecture</h2>
<p>The current architecture still departs from the reference transformer in several respects: it omits residual connections, layer normalization, and position-wise feed-forward blocks. The logical next experiment is therefore to <strong>level up to a bona-fide vanilla transformer</strong>, preserving the current tokenization while adding:</p>
<ol type="1">
<li><strong>Residual (skip) connections</strong> and <strong>pre-LayerNorm</strong>,<br>
</li>
<li><strong>Feed-forward sub-layers</strong> with RELU activations,<br>
</li>
<li><strong>Scaled dot-product attention</strong> with the canonical <span class="math inline">\(1/\sqrt{d}\)</span> factor,<br>
</li>
<li><strong>Dropout</strong> and <strong>weight-decay</strong> for regularization to prevent overfitting.</li>
</ol>
<p>It’s worth noting that transformers excel at sequence modeling—and sequences are ordered collections. While the loci in this dataset could be attributed chromosomal coordinates, and therefore in a sense an ordering, like <span class="citation" data-cites="Rijal2025">Rijal et al. (<a href="#ref-Rijal2025" role="doc-biblioref">2025</a>)</span>, we’re treating the loci as an unordered collection. Thus, we don’t add any positional encodings, either in the form of absolute or relative positional encodings.</p>
<div id="112687cf" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>NUM_REPLICATES <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>jobs <span class="op">=</span> []</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(NUM_REPLICATES):</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    replicate_id <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>i<span class="sc">:02d}</span><span class="ss">"</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    job_name_prefix <span class="op">=</span> <span class="ss">f"xformer_rep_</span><span class="sc">{</span>replicate_id<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    model_config <span class="op">=</span> ModelConfig(</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>        embedding_dim<span class="op">=</span><span class="dv">256</span>,</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>        model_type<span class="op">=</span><span class="st">"transformer"</span>,</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>        seq_length<span class="op">=</span><span class="dv">1164</span>,</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>        num_layers<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>        nhead<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>        dim_feedforward<span class="op">=</span><span class="dv">1024</span>,</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    train_config <span class="op">=</span> attrs.evolve(</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>        train_template_config,</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>        save_dir<span class="op">=</span>Path(<span class="st">"models/transformer"</span>),</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>        phenotypes<span class="op">=</span>phenotype_names,</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>        name_prefix<span class="op">=</span>job_name_prefix,</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>        optimizer<span class="op">=</span><span class="st">"adamw"</span>,</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>        max_epochs<span class="op">=</span><span class="dv">80</span>,</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    jobs.append((model_config, train_config))</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Generated </span><span class="sc">{</span><span class="bu">len</span>(jobs)<span class="sc">}</span><span class="ss"> job configurations."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Generated 5 job configurations.</code></pre>
</div>
</div>
<div id="f19ffd48" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>model_dirs <span class="op">=</span> run_trainings(jobs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Pre-trained model 'xformer_rep_00' found. Returning path.
Pre-trained model 'xformer_rep_01' found. Returning path.
Pre-trained model 'xformer_rep_02' found. Returning path.
Pre-trained model 'xformer_rep_03' found. Returning path.
Pre-trained model 'xformer_rep_04' found. Returning path.</code></pre>
</div>
</div>
<p><a href="#fig-xformer" class="quarto-xref">Figure&nbsp;3</a> shows the change in performance:</p>
<div id="cell-fig-xformer" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>label_lookup <span class="op">=</span> {</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"std"</span>: <span class="st">"Canonical"</span>,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"xformer"</span>: <span class="st">"Transformer"</span>,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_phenotype_r2_data_xformer(model_dir: Path) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine the architecture and replicate number from model directory name</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    dir_name <span class="op">=</span> model_dir.parent.parent.name  <span class="co"># e.g., "std_d128_rep_09"</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    variant_key, _, rep_str <span class="op">=</span> dir_name.rpartition(<span class="st">"_rep_"</span>)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    architecture_label <span class="op">=</span> label_lookup[variant_key]</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load and wrangle the metrics.csv. Keep only the per-phenotype test R2 values.</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(model_dir <span class="op">/</span> <span class="st">"metrics.csv"</span>)</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df[df[<span class="st">"metric"</span>].<span class="bu">str</span>.startswith(<span class="st">"test_r2_"</span>)]</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"phenotype"</span>] <span class="op">=</span> df[<span class="st">"metric"</span>].<span class="bu">str</span>[<span class="dv">8</span>:]</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    df.drop(<span class="st">"metric"</span>, axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    df.rename(columns<span class="op">=</span>{<span class="st">"value"</span>: <span class="st">"r2"</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"architecture"</span>] <span class="op">=</span> architecture_label</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"replicate"</span>] <span class="op">=</span> <span class="bu">int</span>(rep_str)</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"r2"</span>] <span class="op">=</span> df[<span class="st">"r2"</span>].astype(<span class="bu">float</span>)</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Concat the phenotype data across all models</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.concat([get_phenotype_r2_data_xformer(model_dir) <span class="cf">for</span> model_dir <span class="kw">in</span> model_dirs])</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.groupby([<span class="st">"architecture"</span>, <span class="st">"phenotype"</span>])[<span class="st">"r2"</span>].agg(mean_r2<span class="op">=</span><span class="st">"mean"</span>, std_r2<span class="op">=</span><span class="st">"std"</span>).reset_index()</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Concat with existing canonical plot data</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>xformer_plot_data <span class="op">=</span> pd.concat([df, canonical_plot_data])</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting code.</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>xformer_plot_data[<span class="st">"phenotype"</span>] <span class="op">=</span> pd.Categorical(</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>    xformer_plot_data[<span class="st">"phenotype"</span>], categories<span class="op">=</span>phenotype_names, ordered<span class="op">=</span><span class="va">True</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>arch_order <span class="op">=</span> [<span class="st">"Rijal"</span>, <span class="st">"Canonical"</span>, <span class="st">"Transformer"</span>]</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.arange(<span class="bu">len</span>(phenotype_names))</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>width <span class="op">=</span> <span class="fl">0.25</span></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>color_map <span class="op">=</span> {</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Rijal"</span>: apc.cloud,</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Canonical"</span>: apc.mars,</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Transformer"</span>: apc.dragon,</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mpl.rc_context({<span class="st">"figure.facecolor"</span>: apc.parchment}):</span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>    plt.figure(dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, arch <span class="kw">in</span> <span class="bu">enumerate</span>(arch_order):</span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>        sub <span class="op">=</span> (</span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>            xformer_plot_data[xformer_plot_data[<span class="st">"architecture"</span>] <span class="op">==</span> arch]</span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>            .set_index(<span class="st">"phenotype"</span>)</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>            .reindex(phenotype_names)</span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>        plt.bar(</span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>            x <span class="op">+</span> (i <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> width,  <span class="co"># centre bars around tick</span></span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>            sub[<span class="st">"mean_r2"</span>],</span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>            width,</span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>            yerr<span class="op">=</span>sub[<span class="st">"std_r2"</span>],</span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>            ecolor<span class="op">=</span><span class="st">"#00000099"</span>,</span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>            error_kw<span class="op">=</span><span class="bu">dict</span>(elinewidth<span class="op">=</span><span class="fl">1.5</span>),</span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span>arch,</span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>color_map[arch],</span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a>    plt.xticks(x, phenotype_names, rotation<span class="op">=</span><span class="dv">90</span>)</span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">"Phenotype"</span>)</span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">"Mean $R^2$ (± SD)"</span>)</span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a>    plt.ylim(<span class="fl">0.43</span>, <span class="fl">0.69</span>)</span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a>    plt.legend(loc<span class="op">=</span>(<span class="fl">0.05</span>, <span class="fl">0.92</span>), ncol<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-xformer" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-xformer-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_v1.2_files/figure-html/fig-xformer-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-xformer-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: The vanilla transformer performances added alongside the models compared in <a href="#fig-std" class="quarto-xref">Figure&nbsp;2</a>.
</figcaption>
</figure>
</div>
</div>
</div>
<p>The full transformer nudges performance above the already-improved canonical model across most phenotypes (<a href="#fig-xformer" class="quarto-xref">Figure&nbsp;3</a>). The lift is apparent, but no stepwise performance gains are observed. There’s undoubtedly a lot of room for improvement: we made no attempt at hyper-parameter tuning beyond some cursory investigations of dropout and weight-decay (neither of which positively affected performance), and all other parameters were guessed zero shot.</p>
</section>
<section id="conclusion-and-outlook" class="level2">
<h2 class="anchored" data-anchor-id="conclusion-and-outlook">Conclusion and outlook</h2>
<p>Our central question was simple: <em>do off-the-shelf transformer components—and a genuine multi-output head—move the needle on genotype to phenotype prediction?</em></p>
<p>The answer is an emphatic <strong>yes</strong>.</p>
<section id="why-multi-output-matters" class="level3">
<h3 class="anchored" data-anchor-id="why-multi-output-matters">Why multi-output matters</h3>
<p>Leveraging mutual information between genetically correlated phenotypes represents a natural way of boosting model performance when training data is limited. In the context of plant/animal breeding, multi-trait genomic prediction has been well established to improve the predictive power of linear models (particularly for low heritability traits) <span class="citation" data-cites="Jia2012">(<a href="#ref-Jia2012" role="doc-biblioref">Jia and Jannink, 2012</a>)</span>. Our own work with phenotype-phenotype autoencoders has demonstrated that encoding multiple phenotypes jointly lets an auto-encoder predict individual phenotypes with very high accuracy, particularly as the number of phenotypes considered simultaneously increases <span class="citation" data-cites="Avasthi2023">(<a href="#ref-Avasthi2023" role="doc-biblioref">Avasthi et al., 2023</a>)</span>. These observations are examples of the benefits of multi-task learning, which have long been appreciated in ML literature <span class="citation" data-cites="Caruana1997">(<a href="#ref-Caruana1997" role="doc-biblioref">Caruana, 1997</a>)</span>. Our presented results are no different: when the network can see all 18 phenotypes at once, shared genetic effects (either through pleiotropy or in some instances through LD <span class="citation" data-cites="Jobran2021">(<a href="#ref-Jobran2021" role="doc-biblioref">Chebib and Guillaume, 2021</a>)</span>) reinforce, rather than fragment, the learning signal.</p>
</section>
<section id="a-foundation-not-a-finish-line" class="level3">
<h3 class="anchored" data-anchor-id="a-foundation-not-a-finish-line">A foundation, not a finish line</h3>
<p>A natural next step given these results is to test cross-environment transfer learning in our multi-task model. <span class="citation" data-cites="Rijal2025">Rijal et al. (<a href="#ref-Rijal2025" role="doc-biblioref">2025</a>)</span> demonstrated that transfer learning was possible across temperature growth conditions even with a multi-environment model that did not outperform a single-environment model. Given the overall superior performance of the models we present here, they may be particularly well suited for fitness prediction for novel phenotypes with even fewer fine-tuning observations than used by <span class="citation" data-cites="Rijal2025">Rijal et al. (<a href="#ref-Rijal2025" role="doc-biblioref">2025</a>)</span>.</p>
<p>Finally, it would be interesting to evaluate where the performance boost of multi-task learning comes from, from a quantitative genetics perspective. Phenotypic variance can generally be broken down into additive (<span class="math inline">\(G\)</span>), epistatic (<span class="math inline">\(G \times G\)</span>) and gene by environment (<span class="math inline">\(G \times E\)</span>) components (ignoring higher order terms for simplicity). Intuitively, we might expect multi-trait learning to excel at explaining <span class="math inline">\(G\)</span> and <span class="math inline">\(G \times G\)</span> variance components that are constant across environments, however it’s possible that <span class="math inline">\(G \times E\)</span> variance is also better explained, as multi-task learning benefits are known to extend to even unrelated tasks <span class="citation" data-cites="Paredes2012">(<a href="#ref-Paredes2012" role="doc-biblioref">Paredes et al., 2012</a>)</span>. We suspect this could be investigated through ablation studies that track environment specific prediction outcomes.</p>
<p>There is also still plenty of headroom for improving the model:</p>
<ul>
<li>No hyper-parameter search was attempted for the transformer; depth, head count, LR schedules, dropout rates, and layer widths all remain untouched.</li>
<li>How far can the canonical model be pushed? Maybe the transformer is overkill.</li>
<li>The model treats the loci as an unordered collection. It’s possible that adding chromosomal coordinates or some kind of other positional encoding could let the model sing.</li>
<li>We haven’t experimented with more sophisticated feature selection methods for reducing the number of loci prior to model training, a task that may be particularly fruitful for improving the ability of models to capture pairwise and higher order epistasis.</li>
</ul>
</section>
<section id="an-invitation-to-build-further" class="level3">
<h3 class="anchored" data-anchor-id="an-invitation-to-build-further">An invitation to build further</h3>
<p>All code, configs, and cached model checkpoints are available in this notebook’s <a href="https://github.com/Arcadia-Science/2025-geno-pheno-attention">repository</a>. The Appendix documents the engineering decisions that should help orient you to the codebase.</p>
</section>
</section>
<section id="appendix-a-codebase-primer" class="level2">
<h2 class="anchored" data-anchor-id="appendix-a-codebase-primer">Appendix: a codebase primer</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This section elaborates on engineering details that will be of interest to those planning to reproduce, modify, or build off of this research.</p>
</div>
</div>
<p>Rather than building off the <span class="citation" data-cites="Rijal2025">Rijal et al. (<a href="#ref-Rijal2025" role="doc-biblioref">2025</a>)</span> notebook files, we re-implemented their code into our own codebase to improve code quality and make room for our modifications and experimentation. Here is a very high-level summary of the changes we made:</p>
<ul>
<li>Added configuration dataclasses to co-localize tunables</li>
<li>Saved the training/validation/test datasets to file to avoid splitting on-the-fly</li>
<li>Created PyTorch dataloaders to manage accession, batching, and data shuffling</li>
<li>Automated the training loop with <a href="https://lightning.ai/docs/pytorch/stable/">PyTorch Lightning</a>, creating separation between the training loop and the model logic</li>
<li>Added canonical learning parameters like early stopping, learning rate scheduling, gradient norm clipping, weight decay, and more</li>
<li>Generalized the <span class="citation" data-cites="Rijal2025">Rijal et al. (<a href="#ref-Rijal2025" role="doc-biblioref">2025</a>)</span> model with toggleable skip connections, layer normalization, scaled attention, dropout rate, and more</li>
</ul>
<p>The upshot is that we’re proud of this code and think it establishes a much-needed foundation that can be used to build off the research seeded by <span class="citation" data-cites="Rijal2025">Rijal et al. (<a href="#ref-Rijal2025" role="doc-biblioref">2025</a>)</span>.</p>
<section id="training-models" class="level3">
<h3 class="anchored" data-anchor-id="training-models">Training models</h3>
<p>In the analysis above, we illustrated how multiple training jobs can be run using the high level entrypoint, <code>run_trainings</code>, that:</p>
<ul>
<li>Trains a model for a given set of phenotypes</li>
<li>Determines the best model, defined as the model with the lowest loss (MSE) calculated over the validation dataset</li>
<li>Reports the <span class="math inline">\(R^2\)</span> for the test dataset using the best model</li>
<li>Saves the model to file for downstream use</li>
</ul>
<p>The codebase also exposes equivalent behavior through a command-line interface (CLI). It can be accessed via:</p>
<pre class="shell"><code>$ python -m analysis.train --help</code></pre>
</section>
<section id="distributed-computing" class="level3">
<h3 class="anchored" data-anchor-id="distributed-computing">Distributed computing</h3>
<p>We performed the analysis using <a href="https://modal.com/">Modal</a>’s cloud infrastructure to distribute computations across GPUs, allowing us to rapidly measure performance across many different model architectures and training specifications. Whether you want to train with or without Modal can be toggled by the attribute <code>train.use_modal</code>. By default, Modal execution is disabled. The downside is that your training jobs will run in serial, rather than being distributed across different machines.</p>
</section>
<section id="caching-behavior" class="level3">
<h3 class="anchored" data-anchor-id="caching-behavior">Caching behavior</h3>
<p>We implemented a simple cache mechanism that avoids training if a model directory for a given training config already exists. We did this so that GPUs aren’t a requirement for engaging with this research.</p>
<ul>
<li><code>train_config.use_cache = True</code> (default): Skips retraining if a model with the same configuration already exists</li>
<li><code>train_config.use_cache = False</code>: Forces retraining regardless of existing models</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>All training runs in this analysis use the default caching mode (<code>train_config.use_cache = True</code>), and the results are git tracked. As a result, if you execute this notebook locally, these models will be loaded from cache rather than retrained.</p>
</div>
</div>



</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-Avasthi2023" class="csl-entry" role="listitem">
Avasthi P, Mets DG, York R. (2023). Harnessing genotype-phenotype nonlinearity to accelerate biological prediction. <a href="https://doi.org/10.57844/arcadia-5953-995f">https://doi.org/10.57844/arcadia-5953-995f</a>
</div>
<div id="ref-Caruana1997" class="csl-entry" role="listitem">
Caruana R. (1997). Multitask <span>Learning</span>. <a href="https://doi.org/10.1023/A:1007379606734">https://doi.org/10.1023/A:1007379606734</a>
</div>
<div id="ref-Jobran2021" class="csl-entry" role="listitem">
Chebib J, Guillaume F. (2021). Pleiotropy or linkage? Their relative contributions to the genetic correlation of quantitative traits and detection by multitrait GWA studies. <a href="https://doi.org/10.1093/genetics/iyab159">https://doi.org/10.1093/genetics/iyab159</a>
</div>
<div id="ref-Jia2012" class="csl-entry" role="listitem">
Jia Y, Jannink J-L. (2012). Multiple-trait genomic selection methods increase genetic value prediction accuracy. <a href="https://doi.org/10.1534/genetics.112.144246">https://doi.org/10.1534/genetics.112.144246</a>
</div>
<div id="ref-Ba2022" class="csl-entry" role="listitem">
Nguyen Ba AN, Lawrence KR, Rego-Costa A, Gopalakrishnan S, Temko D, Michor F, Desai MM. (2022). Barcoded bulk QTL mapping reveals highly polygenic and epistatic architecture of complex traits in yeast. <a href="https://doi.org/10.7554/eLife.73983">https://doi.org/10.7554/eLife.73983</a>
</div>
<div id="ref-Paredes2012" class="csl-entry" role="listitem">
Paredes BR, Argyriou A, Berthouze N, Pontil M. (2012). <a href="https://proceedings.mlr.press/v22/romera12.html">Exploiting unrelated tasks in multi-task learning</a>
</div>
<div id="ref-Rijal2025" class="csl-entry" role="listitem">
Rijal K, Holmes CM, Petti S, Reddy G, Desai MM, Mehta P. (2025). Inferring genotype-phenotype maps using attention models. <a href="https://doi.org/10.1101/2025.04.11.648465">https://doi.org/10.1101/2025.04.11.648465</a>
</div>
<div id="ref-Vaswani2017" class="csl-entry" role="listitem">
Vaswani A, Shazeer N, Parmar N, Uszkoreit J, Jones L, Gomez AN, Kaiser L, Polosukhin I. (2017). <a href="http://arxiv.org/abs/1706.03762">Attention is all you need</a>
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/Arcadia-Science\.github\.io\/2025-geno-pheno-attention\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
        for (let i=0; i<annoteTargets.length; i++) {
          const annoteTarget = annoteTargets[i];
          const targetCell = annoteTarget.getAttribute("data-target-cell");
          const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
          const contentFn = () => {
            const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
            if (content) {
              const tipContent = content.cloneNode(true);
              tipContent.classList.add("code-annotation-tip-content");
              return tipContent.outerHTML;
            }
          }
          const config = {
            allowHTML: true,
            content: contentFn,
            onShow: (instance) => {
              selectCodeLines(instance.reference);
              instance.reference.classList.add('code-annotation-active');
              window.tippy.hideAll();
            },
            onHide: (instance) => {
              unselectCodeLines();
              instance.reference.classList.remove('code-annotation-active');
            },
            maxWidth: 300,
            delay: [50, 0],
            duration: [200, 0],
            offset: [5, 10],
            arrow: true,
            appendTo: function(el) {
              return el.parentElement.parentElement.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'quarto',
            placement: 'right',
            popperOptions: {
              modifiers: [
              {
                name: 'flip',
                options: {
                  flipVariations: false, // true by default
                  allowedAutoPlacements: ['right'],
                  fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
                },
              },
              {
                name: 'preventOverflow',
                options: {
                  mainAxis: false,
                  altAxis: false
                }
              }
              ]        
            }      
          };
          window.tippy(annoteTarget, config); 
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark">
<script>
  function loadGiscus() {
    // Function to get the theme based on body class
    const getTheme = () => {
      let baseTheme = document.getElementById('giscus-base-theme').value;
      let altTheme = document.getElementById('giscus-alt-theme').value;
      return document.body.classList.contains('quarto-dark') ? altTheme : baseTheme;
    };
    const script = document.createElement("script");
    script.src = "https://giscus.app/client.js";
    script.async = true;
    script.dataset.repo = "Arcadia-Science/2025-geno-pheno-attention";
    script.dataset.repoId = "R_kgDOOdSnMQ";
    script.dataset.category = "General";
    script.dataset.categoryId = "DIC_kwDOOdSnMc4CprnF";
    script.dataset.mapping = "title";
    script.dataset.reactionsEnabled = "1";
    script.dataset.emitMetadata = "0";
    script.dataset.inputPosition = "top";
    script.dataset.theme = getTheme();
    script.dataset.lang = "en";
    script.crossOrigin = "anonymous";
    // Append the script to the desired div instead of at the end of the body
    document.getElementById("quarto-content").appendChild(script);
  }
  loadGiscus();
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><a href="https://www.arcadiascience.com/"><img src="./assets/logo_white.png" class="img-fluid" alt="Arcadia-Science" width="65"></a> Copyright 2025, Arcadia Science</p>
</div>   
    <div class="nav-footer-center">

<div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/arcadiascience">
      <i class="bi bi-twitter-x" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/Arcadia-Science">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>